<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script
    src="https://code.jquery.com/jquery-3.6.0.min.js"
    integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
    crossorigin="anonymous"></script>
</head>
<body>
    
</body>
<script type="text/javascript">
    'use strict';
    (function($){
        let invoices = {
            "customer" : "BigCo",
            "performances" : [
                {
                    "playID" : "hamlet",
                    "audience" : 55
                },
                {
                    "playID" : "as-like",
                    "audience" : 35
                },
                {
                    "playID" : "othello",
                    "audience" : 40
                }
            ]
        };
        let plays = {
            "hamlet"   : {"name": "Hamlet", "type": "tragedy"},
            "as-like"  : {"name": "As You like it", "type": "comedy"},
            "othello"  : {"name": "Othello", "type": "tragedy"}
        }

        /**
         * Let's refactoring
         * 
         * 1. switch 문 제거 ('함수 추출하기')
         * - amountFor() 함수로 기능 분리
         * 
         * 2. amountFor() 함수 변경
         * - perf -> aPerfomance
         * - play 인자 제거 
         *   - playFor() 함수 생성 ('임시 변수를 질의 함수로 바꾸기')
         *   - playFor() '변수 인라인하기'
         * - amountFor() '변수 인라인하기'
         * 
         * 3. volumeCredits(적립금) 처리 함수 추가.
         * 4. format 임시변수 제거하기
         * 5. volumeCredits 변수 제거하기
         * - '반복문 쪼개기'
         * - '문장 슬라이드' 처리 (변수 선언 문장 반복문 앞으로 선언)
         * - '임시 변수를 질의 함수로 바꾸기, 함수로 추출'
         * - '변수를 인라인'
         * 6. totalAmount 변수 제거하기
         * 7. 내부 함수에 쓰이는 return 변수 명 스타일대로 고치기.
         * 8. 결과 HTML 출력 구조 구성하기
         * - 계산 단계와 포멧팅 단계 분리하기
         *    - renderPlainText() 함수로 전체 분리
         *    - renderPlainText() 에서 필요한 data 구성하기
         */ 
        function statement(invoices, plays) {
            const statementData = {};
            statementData.customer = invoices.customer;
            statementData.performances = invoices.performances.map(enrichPerformance);

            return renderPlainText(statementData, invoices, plays);

            function enrichPerformance(aPerformance) {
                const result = Object.assign({}, aPerformance);
                result.play = playFor(result);    
                result.amount = amountFor(result);
                return result;
            }

            function playFor(aPerformance) {
                return plays[aPerformance.playID];
            }

            function amountFor(aPerformance) {
                let result = 0;
    
                switch (aPerformance.play.type) {
                    case "tragedy": //비극
                        result = 40000;
                        if (aPerformance.audience > 30 ) {
                            result += 1000 * (aPerformance.audience - 30);
                        }
                    break;
                    case "comedy": //코메디
                        result = 30000;
                        if (aPerformance.audience > 20) {
                            result += 10000 + 500 * (aPerformance.audience - 20);
                        }
                        result += 300 * aPerformance.audience;
                    break;
                    default:
                        throw new Error(`알수 없는 장르: ${perf.play.type}`);
                }

                return result;

            }
        }

        function renderPlainText(data, invoices, plays) {
            let result = `청구 내역 (고객명: ${data.customer})\n`;
            
            for (let perf of data.performances) {
                //청구 내역을 출력한다.
                result += ` ${perf.play.name}: ${usd(perf.amount)} (${perf.audience}석)\n`;
            }

            result += `총액: ${usd(totalAmount())}\n`;
            result += `적립 포인트: ${volumeCreditsFor()}점\n`;
            return result;

            function volumeCreditsFor() {
                let result = 0;
                for (let perf of data.performances) {
                    result += Math.max(perf.audience - 30, 0);
                    // 희극 관객 5명마다 추가 포인트를 제공한다.
                    if ("comedy" === perf.play.type) {
                        result += Math.floor(perf.audience / 5);
                    }
                } 

                return result;
            }

            function usd(aNumber) {
                return new Intl.NumberFormat("en-US",  { style: "currency", currency: "USD", minimumFractionDigits: 2}).format(aNumber/100);
            }

            function totalAmount() {
                let result = 0;
                for (let perf of data.performances) {
                    result += perf.amount; 
                }
                return result;
            }

        }

        console.log(statement(invoices, plays));
        
    })(jQuery);
</script>
</html>